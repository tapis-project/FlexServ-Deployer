name: Publish Tapis Job Bundle

on:
  workflow_dispatch:
    inputs:
      publish_release:
        description: "Publish zip as a GitHub Release asset"
        required: true
        default: true
        type: boolean
      tag:
        description: "Optional release tag (for example: tapis-flexserv-1.3.0)"
        required: false
        type: string

jobs:
  bundle:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute bundle metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.tag }}" ]; then
              TAG="${{ inputs.tag }}"
          else
              TAG="tapis-flexserv-$(date +'%Y%m%d-%H%M%S')"
          fi
          ZIP_NAME="Tapis-FlexServ.zip"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "zip_name=${ZIP_NAME}" >> "$GITHUB_OUTPUT"

      - name: Build zip with required structure
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist/package/app

          cp hpc_archive/tapisjob.manifest dist/package/tapisjob.manifest
          cp hpc_archive/app/run_flexserv.sh dist/package/app/run_flexserv.sh
          chmod +x dist/package/app/run_flexserv.sh

          (
              cd dist/package
              zip -r "../${{ steps.meta.outputs.zip_name }}" tapisjob.manifest app/run_flexserv.sh
          )

          echo "Created dist/${{ steps.meta.outputs.zip_name }}"
          unzip -l "dist/${{ steps.meta.outputs.zip_name }}"

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: tapisjob-bundle
          path: dist/${{ steps.meta.outputs.zip_name }}
          if-no-files-found: error

      - name: Publish GitHub Release asset
        if: ${{ inputs.publish_release }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: Tapis Job Bundle (${{ steps.meta.outputs.tag }})
          generate_release_notes: true
          files: |
            dist/${{ steps.meta.outputs.zip_name }}
